<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG PDF Q&A</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0 1rem; background: #f8f9fa; color: #212529; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .container { width: 100%; max-width: 700px; margin: 2rem 0; }
    h1 { margin-bottom: .5rem; font-size: 2.5rem; font-weight: 600; text-align: center; }
    .subtitle { color: #6c757d; margin-bottom: 2.5rem; font-size: 1.1rem; text-align: center; }
    .card { border: 1px solid #dee2e6; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    h2 { margin-top: 0; margin-bottom: 1rem; font-weight: 600; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
    label { display: block; margin: 1rem 0 .5rem; font-weight: 600; color: #495057; }
    input[type="text"], input[type="file"] { width: 100%; box-sizing: border-box; padding: .75rem; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; }
    button { padding: .75rem 1.5rem; border-radius: 8px; border: none; background: #007bff; color: #fff; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background-color 0.2s; }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    .collections-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .collection-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
    .delete-btn { background: #dc3545; color: white; font-size: 0.8rem; padding: 0.4rem 0.8rem; }
    .delete-btn:hover { background: #c82333; }
    .muted { color: #6c757d; font-size: .9rem; }
    #results-container { margin-top: 2rem; }
    pre { white-space: pre-wrap; word-wrap: break-word; background: #f6f6f6; padding: 1rem; border-radius: 8px; font-size: 1.05rem; line-height: 1.6; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 2rem auto; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>RAG PDF Q&A</h1>
    <p class="subtitle">Upload a PDF → Ask questions → Get answers powered by Gemini.</p>

    <div class="card">
      <h2>1. Upload & Ingest PDF</h2>
      <form id="upload-form">
        <label for="file-upload">Choose a PDF file</label>
        <input id="file-upload" type="file" name="file" accept="application/pdf" required />
        <label for="collection-name">Collection name (optional)</label>
        <input id="collection-name" type="text" name="collection" placeholder="Defaults to filename" />
        <div style="margin-top:1.5rem"><button type="submit">Upload & Ingest</button></div>
      </form>
    </div>

    <div class="card">
      <h2>2. Ask a Question</h2>
      <form id="ask-form">
        <label for="ask-collection">Collection Name</label>
        <input id="ask-collection" type="text" name="collection" placeholder="Enter the collection name" required />
        <label for="question">Your Question</label>
        <input id="question" type="text" name="question" placeholder="e.g., What are the key findings?" required />
        <div style="margin-top:1.5rem"><button type="submit">Ask</button></div>
      </form>
    </div>

    <div class="card" id="collections-card">
      <h2>Available Collections</h2>
      <div id="collections-grid"></div>
    </div>

    <div id="results-container"></div>
    <div class="loader" id="loader"></div>
  </div>

  <script>
    // Since the JS is served by Flask, API calls are to relative paths.
    const API_BASE_URL = ""; 

    const uploadForm = document.getElementById('upload-form');
    const askForm = document.getElementById('ask-form');
    const resultsContainer = document.getElementById('results-container');
    const loader = document.getElementById('loader');
    const collectionsGrid = document.getElementById('collections-grid');
    const collectionsCard = document.getElementById('collections-card');

    function showLoader(show) { loader.style.display = show ? 'block' : 'none'; }

    async function deleteCollection(collectionName) {
        if (!confirm(`Are you sure you want to delete the collection "${collectionName}"?`)) return;
        
        showLoader(true);
        try {
            const response = await fetch(`${API_BASE_URL}/api/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ collection: collectionName }),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Failed to delete collection');
            fetchCollections(); // Refresh the list
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            showLoader(false);
        }
    }

    async function fetchCollections() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/collections`);
            const data = await response.json();
            collectionsGrid.innerHTML = '';
            if (data.collections && data.collections.length > 0) {
                collectionsCard.style.display = 'block';
                data.collections.forEach(c => {
                    const item = document.createElement('div');
                    item.className = 'collection-item';
                    item.innerHTML = `<span>${c}</span>`;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.onclick = () => deleteCollection(c);
                    item.appendChild(deleteBtn);
                    collectionsGrid.appendChild(item);
                });
            } else {
                collectionsCard.style.display = 'none';
            }
        } catch (error) {
            console.error('Error fetching collections:', error);
            collectionsGrid.innerHTML = '<p class="muted">Could not load collections.</p>';
        }
    }

    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        const submitButton = uploadForm.querySelector('button');
        resultsContainer.innerHTML = '';
        showLoader(true);
        submitButton.disabled = true;

        try {
            const response = await fetch(`${API_BASE_URL}/api/upload`, { method: 'POST', body: formData });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Upload failed');
            
            resultsContainer.innerHTML = `<div class="card"><h3>Ingestion Complete ✅</h3><p>Added <strong>${result.ingested_chunks}</strong> chunks to collection <strong>${result.collection}</strong>.</p></div>`;
            document.getElementById('ask-collection').value = result.collection;
            fetchCollections();
        } catch (error) {
            resultsContainer.innerHTML = `<div class="card"><p style="color:red;">Error: ${error.message}</p></div>`;
        } finally {
            showLoader(false);
            submitButton.disabled = false;
        }
    });

    askForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const collection = document.getElementById('ask-collection').value;
        const question = document.getElementById('question').value;
        const submitButton = askForm.querySelector('button');
        resultsContainer.innerHTML = '';
        showLoader(true);
        submitButton.disabled = true;

        try {
            const response = await fetch(`${API_BASE_URL}/api/ask`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ collection, question }),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Failed to get an answer');

            let sourcesHtml = '';
            if (result.sources && result.sources.length > 0) {
                sourcesHtml = `<div class="card"><h3>Sources Used</h3><ul>${result.sources.map(s => `<li>${s}</li>`).join('')}</ul></div>`;
            }
            resultsContainer.innerHTML = `<div class="card"><h3>Answer</h3><p><strong>Question:</strong> ${result.question}</p><pre>${result.answer}</pre></div>${sourcesHtml}`;
        } catch (error) {
            resultsContainer.innerHTML = `<div class="card"><p style="color:red;">Error: ${error.message}</p></div>`;
        } finally {
            showLoader(false);
            submitButton.disabled = false;
        }
    });

    // Fetch collections on page load
    document.addEventListener('DOMContentLoaded', fetchCollections);
  </script>
</body>
</html>
